import{B as U,I as W,r as se}from"./button-af00bb43.js";import{o as ne,L as oe,t as ae,C as M,m as re}from"./wrapEmojiText-7a9a7c39.js";import{ae as q,M as le,c as X,ar as ce,g as Y,F as z,ag as he,a as de,ah as N,E as ue,af as H,d as $,a7 as pe,i as K}from"./index-ee5db018.js";import{a as L,d as fe}from"./page-f4384e73.js";import{S as me}from"./scrollable-8ee479fd.js";function ve(t){return q&&t instanceof TouchEvent&&t.touches[0].clientX<30}class ge{constructor(){if(this.onPopState=e=>{const s=window.location.hash,i=e.state;if(this.debug&&this.log("popstate",e,this.isPossibleSwipe,s),s!==this.currentHash)if(this.debug&&this.log.warn(`hash changed, new=${s}, current=${this.currentHash}, overridden=${this.overriddenHash}`),i===this.id&&this.overriddenHash&&this.overriddenHash!==s)this.overrideHash(this.overriddenHash);else if(i&&!this.overriddenHash&&s)this.overrideHash();else{this.currentHash=s,this.onHashChange&&this.onHashChange();return}if(i!==this.id&&(this.pushState(),!this.navigations.length))return;const o=this.navigations.pop();if(!o){this.pushState();return}this.manual=!this.isPossibleSwipe,this.handleItem(o,this.navigations.length)},this.onKeyDown=e=>{const s=this.navigations[this.navigations.length-1];s&&e.key==="Escape"&&(!s.onEscape||s.onEscape())&&(X(e),this.back(s.type))},this.onTouchStart=e=>{e.touches.length>1||(this.debug&&this.log("touchstart"),ve(e)&&(this.isPossibleSwipe=!0,window.addEventListener("touchend",()=>{setTimeout(()=>{this.isPossibleSwipe=!1},100)},{passive:!0,once:!0})))},this.navigations=[],this.id=Date.now(),this.manual=!1,this.log=ce("NC"),this.debug=!0,this.currentHash=window.location.hash,this.overriddenHash="",this.isPossibleSwipe=!1,window.addEventListener("popstate",this.onPopState),window.addEventListener("keydown",this.onKeyDown,{capture:!0,passive:!1}),q){const e={passive:!0};window.addEventListener("touchstart",this.onTouchStart,e)}history.scrollRestoration="manual",this.pushState()}overrideHash(e=""){e&&e[0]!=="#"?e="#"+e:e==="#"&&(e=""),this.currentHash!==e&&(this.overriddenHash=this.currentHash=e,this.replaceState(),this.pushState())}handleItem(e,s=this.navigations.indexOf(e)){const i=e.onPop(this.manual?void 0:!1);this.debug&&this.log("popstate, navigation:",e,this.navigations),i===!1?this.spliceItems(Math.min(this.navigations.length,s),0,e):e.noBlurOnPop||Y(),this.manual=!1}findItemByType(e){for(let s=this.navigations.length-1;s>=0;--s){const i=this.navigations[s];if(i.type===e)return{item:i,index:s}}}back(e){if(e){const s=this.findItemByType(e);if(s){this.backByItem(s.item,s.index);return}}history.back()}backByItem(e,s=this.navigations.indexOf(e)){s!==-1&&(this.manual=!0,this.navigations.splice(s,1),this.handleItem(e,s))}onItemAdded(e){this.debug&&this.log("onItemAdded",e,this.navigations),e.noHistory||this.pushState()}pushItem(e){this.navigations.push(e),this.onItemAdded(e)}unshiftItem(e){this.navigations.unshift(e),this.onItemAdded(e)}spliceItems(e,s,...i){this.navigations.splice(e,s,...i),i.forEach(o=>{this.onItemAdded(o)})}pushState(){this.debug&&this.log("push"),this.manual=!1,history.pushState(this.id,"")}replaceState(){this.debug&&this.log.warn("replace");const e=location.origin+location.pathname+location.search+this.overriddenHash;history.replaceState(this.id,"",e)}removeItem(e){e&&z(this.navigations,e)}removeByType(e,s=!1){for(let i=this.navigations.length-1;i>=0&&!(this.navigations[i].type===e&&(this.navigations.splice(i,1),s));--i);}}const w=new ge;le.appNavigationController=w;function be(t){if(t.key==="Enter"&&!he&&!t.isComposing){if(de.settings.sendShortcut==="enter")return t.shiftKey||t.ctrlKey||t.metaKey?void 0:!0;{const e=N?t.metaKey:t.ctrlKey;if(t.shiftKey||(N?t.ctrlKey:t.metaKey))return;if(e)return!0}}return!1}function Ae(t){t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen()}function Oe(){document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()}function ye(t,e,s){const i=s?s.add(t):t.addEventListener.bind(t);"webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange".split(" ").forEach(o=>{i(o,e,!1)})}function j(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function Fe(){return!!j()}const Ce=(t,e={})=>{const s=t?.split(" ");return U("btn-icon"+(s?.length>1?" "+s.slice(1).join(" "):""),{icon:s?.[0]||void 0,...e})},A=document.body;let C=A;const G=()=>{C=j()||A,O.reAppend()};ye(A,G);const g=class extends ue{constructor(t,e={}){if(super(!1),this.element=document.createElement("div"),this.container=document.createElement("div"),this.header=document.createElement("div"),this.title=document.createElement("div"),this.element.classList.add("popup"),this.element.className="popup"+(t?" "+t:""),this.container.classList.add("popup-container","z-depth-1"),H.isDarkOverlayActive&&(this.night=!0,this.element.classList.add("night")),this.header.classList.add("popup-header"),e.title&&(this.title.classList.add("popup-title"),typeof e.title=="string"?$(this.title,e.title):typeof e.title!="boolean"&&this.title.append(e.title),this.header.append(this.title)),this.isConfirmationNeededOnClose=e.isConfirmationNeededOnClose,this.middlewareHelper=ne(),this.listenerSetter=new oe,this.managers=g.MANAGERS,this.confirmShortcutIsSendShortcut=e.confirmShortcutIsSendShortcut,e.closable&&(this.btnClose=Ce("",{noRipple:!0}),this.btnClose.classList.add("popup-close"),this.header.prepend(this.btnClose),e.onBackClick?(this.btnCloseAnimatedIcon=document.createElement("div"),this.btnCloseAnimatedIcon.classList.add("animated-close-icon"),this.btnClose.append(this.btnCloseAnimatedIcon)):this.btnClose.append(W("close")),L(this.btnClose,()=>{e.onBackClick&&this.btnCloseAnimatedIcon.classList.contains("state-back")?(this.btnCloseAnimatedIcon.classList.remove("state-back"),e.onBackClick()):this.hide()},{listenerSetter:this.listenerSetter})),this.withoutOverlay=e.withoutOverlay,this.withoutOverlay&&this.element.classList.add("no-overlay"),e.overlayClosable&&L(this.element,s=>{pe(s.target,"popup-container")||!s.target.isConnected||this.hide()},{listenerSetter:this.listenerSetter}),e.withConfirm&&(this.btnConfirm=document.createElement("button"),this.btnConfirm.classList.add("btn-primary","btn-color-primary"),e.withConfirm!==!0&&this.btnConfirm.append(K(e.withConfirm)),this.header.append(this.btnConfirm)),this.container.append(this.header),e.body&&(this.body=document.createElement("div"),this.body.classList.add("popup-body"),this.container.append(this.body)),e.scrollable){const s=this.scrollable=new me(this.body);if(this.attachScrollableListeners(),e.floatingHeader){this.attachScrollableListeners(this.header);const i=document.createElement("div");i.classList.add("popup-header-background"),this.header.prepend(i),this.header.classList.add("is-floating")}this.body||this.header.after(s.container)}e.footer&&(this.footer=document.createElement("div"),this.footer.classList.add("popup-footer"),(this.body||this.container).append(this.footer)),this.btnConfirmOnEnter=this.btnConfirm,this.setButtons(e.buttons),this.element.append(this.container),g.POPUPS.push(this)}setButtons(t){if(this.buttons=t,this.buttonsEl&&(this.buttonsEl.remove(),this.buttonsEl=void 0),!t?.length)return;const e=this.buttonsEl=document.createElement("div");e.classList.add("popup-buttons");const s=t.map(i=>{const o=document.createElement("button");if(o.className="popup-button btn"+(i.isDanger?" danger":" primary"),i.noRipple||se(o),i.text?o.append(i.text):i.langKey&&o.append(K(i.langKey,i.langArgs)),i.iconLeft||i.iconRight){const u=W(i.iconLeft||i.iconRight,"popup-button-icon",i.iconLeft?"left":"right");o.classList.add("with-icon"),i.iconLeft?o.prepend(u):o.append(u)}return L(o,async u=>{let c=i.callback?.(u);if(c!==void 0&&c instanceof Promise){const p=ae([i.element],!0);try{c=await c}catch{c=!1}c===!1&&p()}c!==!1&&this.hide()},{listenerSetter:this.listenerSetter}),i.element=o});if(!this.btnConfirmOnEnter&&t.length===2){const i=t.find(o=>!o.isCancel);i&&(this.btnConfirmOnEnter=i.element)}t.length>=3&&e.classList.add("is-vertical-layout"),e.append(...s),this.container.append(e)}attachScrollableListeners(t){return this.scrollable.attachBorderListeners(t)}onContentUpdate(){this.scrollable?.onAdditionalScroll?.()}show(){this.navigationItem={type:"popup",onPop:()=>{if(this.isConfirmationNeededOnClose){const t=this.isConfirmationNeededOnClose();if(t)return Promise.resolve(t).then(()=>{this.destroy()}),!1}return this.destroy()}},w.pushItem(this.navigationItem),Y(),C.append(this.element),this.element.offsetWidth,this.element.classList.add("active"),this.onContentUpdate(),this.withoutOverlay||(H.isOverlayActive=!0,M.checkAnimations2(!0)),setTimeout(()=>{this.element.classList.contains("active")&&this.listenerSetter.add(document.body)("keydown",t=>{!this.btnConfirmOnEnter||this.btnConfirmOnEnter.disabled||g.POPUPS[g.POPUPS.length-1]!==this||(this.confirmShortcutIsSendShortcut?be(t):t.key==="Enter")&&(fe(this.btnConfirmOnEnter),X(t))})},0)}hide(){this.destroyed||!this.navigationItem||w.backByItem(this.navigationItem)}hideWithCallback(t){this.addEventListener("closeAfterTimeout",t),this.hide()}forceHide(){return this.destroy()}destroy(){this.destroyed||(this.destroyed=!0,this.dispatchEvent("close"),this.element.classList.add("hiding"),this.element.classList.remove("active"),this.listenerSetter.removeAll(),this.middlewareHelper.destroy(),this.withoutOverlay||(H.isOverlayActive=!1),w.removeItem(this.navigationItem),this.navigationItem=void 0,z(g.POPUPS,this),G(),setTimeout(()=>{this.element.remove(),this.dispatchEvent("closeAfterTimeout"),this.cleanup(),this.scrollable?.destroy(),this.withoutOverlay||M.checkAnimations2(!1)},250))}static reAppend(){this.POPUPS.forEach(t=>{const{element:e,container:s}=t,i=e.parentElement;i&&i!==C&&C!==s&&C.append(e)})}static getPopups(t){return this.POPUPS.filter(e=>e instanceof t)}static createPopup(t,...e){return new t(...e)}};let O=g;O.POPUPS=[];const xe=t=>(t.find(s=>s.isCancel)||t.push({langKey:"Cancel",isCancel:!0}),t);function Ee(t,e){let s,i,o,u=0,c=0,p=0,b=0,y=0;const F=4,h={},Z=50,x=200,B=200;t.complete?T():t.onload=T;function V(){i.removeEventListener("mousedown",E),i.removeEventListener("touchstart",E),i.removeEventListener("wheel",D),document.removeEventListener("mouseup",f),document.removeEventListener("touchend",f),document.removeEventListener("mousemove",m),document.removeEventListener("touchmove",m),document.removeEventListener("keypress",_),s.remove(),i.remove(),o.remove()}function J(){i.addEventListener("mousedown",E,!1),i.addEventListener("touchstart",E,!1),i.addEventListener("wheel",D,!1),document.addEventListener("keypress",_,!1)}function T(){t.classList.add("crop-blur"),t.draggable=!1,o=new Image,o.src=t.src,o.draggable=!1,o.classList.add("crop-overlay-image"),e||(e=document.createElement("canvas")),s=document.createElement("div"),s.classList.add("crop-component"),i=document.createElement("div"),i.classList.add("crop-overlay");const n=document.createElement("div");n.classList.add("crop-overlay-color"),s.appendChild(i),t.parentNode.appendChild(s),s.appendChild(o),s.appendChild(t),s.appendChild(n),i.appendChild(o),o.style.maxWidth=t.width+"px",y=t.naturalWidth/t.offsetWidth;const l=t.offsetWidth/2-x/2,r=t.offsetHeight/2-B/2;R(x,B),P(l,r),k(l,r),J()}function R(n,a){p=n*y,b=a*y,i.style.width=n+"px",i.style.height=a+"px"}function P(n,a){c=a*y,u=n*y,o.style.top=-a+"px",o.style.left=-n+"px"}function k(n,a){i.style.top=a+"px",i.style.left=n+"px"}function Q(n){h.container_width=i.offsetWidth,h.container_height=i.offsetHeight,h.container_left=i.offsetLeft,h.container_top=i.offsetTop,h.mouse_x=(n.clientX||n.pageX||n.touches&&n.touches[0].clientX)+window.scrollX,h.mouse_y=(n.clientY||n.pageY||n.touches&&n.touches[0].clientY)+window.scrollY}function I(n){n=n*Math.PI*2;const a=Math.floor(i.clientWidth+n),l=Math.floor(i.clientHeight+n),r=o.clientWidth,S=o.clientHeight;let d,v;if(a<Z)return;if(a>r)return;d=i.offsetLeft-n/2,v=i.offsetTop-n/2;const te=d+a,ie=v+l;d<0&&(d=0),v<0&&(v=0),!(te>r)&&(ie>S||(R(a,a),P(d,v),k(d,v)))}function _(n){switch(n.preventDefault(),String.fromCharCode(n.charCode)){case"+":I(F);break;case"-":I(-F);break}}function D(n){n.preventDefault(),I(n.deltaY>0?1:-1)}function E(n){n.preventDefault(),n.stopPropagation(),Q(n),document.addEventListener("mousemove",m),document.addEventListener("touchmove",m),document.addEventListener("mouseup",f),document.addEventListener("touchend",f)}function f(n){n.preventDefault(),document.removeEventListener("mouseup",f),document.removeEventListener("touchend",f),document.removeEventListener("mousemove",m),document.removeEventListener("touchmove",m)}function m(n){const a={x:0,y:0};n.preventDefault(),n.stopPropagation(),a.x=n.pageX||n.touches&&n.touches[0].pageX,a.y=n.pageY||n.touches&&n.touches[0].pageY;let l=a.x-(h.mouse_x-h.container_left),r=a.y-(h.mouse_y-h.container_top);const S=i.offsetWidth,d=i.offsetHeight;l<0?l=0:l>o.offsetWidth-S&&(l=o.offsetWidth-S),r<0?r=0:r>o.offsetHeight-d&&(r=o.offsetHeight-d),P(l,r),k(l,r)}function ee(){e.width=p,e.height=b,e.getContext("2d").drawImage(t,u,c,p,b,0,0,p,b)}return{crop:ee,removeHandlers:V}}function Se(t,e){return new Promise(s=>{const i=new FileReader;i.addEventListener("loadend",o=>{s(o.target.result)}),i[e](t)})}function Le(t){return Se(t,"readAsDataURL")}class Be extends O{constructor(e={}){super("popup-avatar",{closable:!0}),this.image=new Image,this.cropper={crop:()=>{},removeHandlers:()=>{}},this.h6=document.createElement("h6"),$(this.h6,"Popup.Avatar.Title"),this.btnClose.classList.remove("btn-icon"),this.header.append(this.h6),this.cropContainer=document.createElement("div"),this.cropContainer.classList.add("crop"),this.cropContainer.append(this.image),e.isForum&&this.cropContainer.classList.add("is-forum"),this.input=document.createElement("input"),this.input.type="file",this.input.style.display="none",this.listenerSetter.add(this.input)("change",s=>{const i=s.target.files[0];i&&Le(i).then(o=>{this.image=new Image,this.cropContainer.append(this.image),this.image.src=o,this.image.onload=()=>{this.show(),this.cropper=Ee(this.image,this.canvas),this.input.value=""}})},!1),this.btnConfirm=U("btn-primary btn-color-primary btn-circle btn-crop btn-icon z-depth-1",{noRipple:!0,icon:"check"}),L(this.btnConfirm,()=>{this.cropper.crop(),this.hide(),this.canvas.toBlob(s=>{this.blob=s,this.darkenCanvas(),this.resolve()},"image/jpeg",1)},{listenerSetter:this.listenerSetter}),this.container.append(this.cropContainer,this.btnConfirm,this.input),this.addEventListener("closeAfterTimeout",()=>{this.cropper.removeHandlers(),this.image&&this.image.remove()})}resolve(){this.onCrop(()=>re.upload(this.blob))}open(e,s){this.canvas=e,this.onCrop=s,this.input.click()}darkenCanvas(){const e=this.canvas.getContext("2d");e.fillStyle="rgba(0, 0, 0, 0.3)",e.fillRect(0,0,this.canvas.width,this.canvas.height)}}export{Ce as B,O as P,Be as a,xe as b,w as c,ye as d,Fe as e,Oe as f,Le as g,be as h,ve as i,Ae as r};
//# sourceMappingURL=avatar-3019fb35.js.map
