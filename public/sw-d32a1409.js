const T={test:location.search.indexOf("test=1")>0,debug:location.search.indexOf("debug=1")>0,http:!1,ssl:!0,multipleConnections:!0,asServiceWorker:!1,transport:"websocket",noSharedWorker:location.search.indexOf("noSharedWorker=1")>0};T.http=location.search.indexOf("http=1")>0;T.http=!0;T.http&&(T.transport="https");const Y=T.debug,Ce=typeof window<"u"?window:self,Z=Ce,b=typeof window<"u"?window:self,L=navigator?navigator.userAgent:null;navigator.userAgent.search(/OS X|iPhone|iPad|iOS/i);navigator.userAgent.toLowerCase().indexOf("android");(()=>{try{return+navigator.userAgent.match(/Chrom(?:e|ium)\/(.+?)(?:\s|\.)/)[1]}catch{}})();const ie="safari"in b||!!(L&&(/\b(iPad|iPhone|iPod)\b/.test(L)||L.match("Safari")&&!L.match("Chrome"))),re=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;(navigator.maxTouchPoints===void 0||navigator.maxTouchPoints>0)&&navigator.userAgent.search(/iOS|iPhone OS|Android|BlackBerry|BB10|Series ?[64]0|J2ME|MIDP|opera mini|opera mobi|mobi.+Gecko|Windows Phone/i)!=-1;const x=typeof ServiceWorkerGlobalScope<"u"&&self instanceof ServiceWorkerGlobalScope,B=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&!x,_e=B||x,oe=()=>self.clients.matchAll({includeUncontrolled:!1,type:"window"}),ae=(t,...e)=>{try{t.postMessage(...e)}catch(s){console.error("[worker] postMessage error:",s,e)}},ce=(t,...e)=>{oe().then(s=>{s.length&&s.slice(t?0:-1).forEach(n=>{ae(n,...e)})})},le=(...t)=>{ae(self,...t)},he=()=>{};x&&ce.bind(null,!1);x&&ce.bind(null,!0);const Ie=Date.now();function ee(){return"["+((Date.now()-Ie)/1e3).toFixed(3)+"]"}var C=(t=>(t[t.None=0]="None",t[t.Error=1]="Error",t[t.Warn=2]="Warn",t[t.Log=4]="Log",t[t.Debug=8]="Debug",t))(C||{});const Oe=[0,1,2,4,8],Me=ie||re,xe=!Me,te={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},Re=[["debug",8],["info",4],["warn",2],["error",1],["assert",1],["trace",4],["group",4],["groupCollapsed",4],["groupEnd",4]];function R(t,e=7,s=!1,n=""){let i;!Y&&!s&&(e=1),xe?n||(x?n=te.fg.yellow:B&&(n=te.fg.cyan)):n="";const r=n;n?n=`%s ${n}%s`:n="%s";const o=function(...a){return e&4&&console.log(n,ee(),t,...a)};return Re.forEach(([a,c])=>{o[a]=function(...l){return e&c&&console[a](n,ee(),t,...l)}}),o.setPrefix=function(a){i=a,t="["+a+"]"},o.setPrefix(t),o.setLevel=function(a){e=Oe.slice(0,a+1).reduce((c,l)=>c|l,0)},o.bindPrefix=function(a,c=e){return R(`${i}] [${a}`,c,s,r)},o}function ue(t){return new Promise(e=>{setTimeout(e,t)})}const De=self,de="cachedAssets";function j(t){return t.ok&&t.status===200}function se(t){return Promise.race([t,ue(1e4).then(()=>Promise.reject())])}async function Le(t){try{const e=await se(De.caches.open(de)),s=await se(e.match(t.request,{ignoreVary:!0}));if(s&&j(s))return s;const n={Vary:"*"};let i=await fetch(t.request,{headers:n});if(j(i))e.put(t.request,i.clone());else if(i.status===304){const r=t.request.url.replace(/\?.+$/,"")+"?"+(Math.random()*1e5|0);i=await fetch(r,{headers:n}),j(i)&&e.put(t.request,i.clone())}return i}catch{return fetch(t.request)}}function Ne(t,e){return new Promise(s=>{const n=new FileReader;n.addEventListener("loadend",i=>{s(i.target.result)}),n[e](t)})}function We(t){return Ne(t,"readAsArrayBuffer")}function Be(t){return We(t).then(e=>new Uint8Array(e))}function fe(){}const Fe={isFulfilled:!1,isRejected:!1,notify:()=>{},notifyAll:function(...t){this.lastNotify=t,this.listeners?.forEach(e=>e(...t))},addNotifyListener:function(t){this.lastNotify&&t(...this.lastNotify),(this.listeners??(this.listeners=[])).push(t)},resolve:function(t){this.isFulfilled||this.isRejected||(this.isFulfilled=!0,this._resolve(t),this.onFinish())},reject:function(...t){this.isRejected||this.isFulfilled||(this.isRejected=!0,this._reject(...t),this.onFinish())},onFinish:function(){this.notify=this.notifyAll=this.lastNotify=null,this.listeners&&(this.listeners.length=0),this.cancel&&(this.cancel=fe)}};function F(){let t,e;const s=new Promise((n,i)=>{t=n,e=i});return Object.assign(s,Fe),s._resolve=t,s._reject=e,s}self.deferredPromise=F;function Ue(t,e,s=!0,n=!0){let i,r,o,a,c=!1;const l=d=>{const p=o,g=a;try{const f=t.apply(null,d);p(f)}catch(f){console.error("debounce error",f),g(f)}},h=(...d)=>{r||(r=new Promise((g,f)=>(o=g,a=f))),i?(clearTimeout(i),c=!0,a(),r=new Promise((g,f)=>(o=g,a=f))):s&&(l(d),c=!1);const p=b.setTimeout(()=>{n&&(!s||c)&&l(d),i===p&&(i=r=o=a=void 0,c=!1)},e);return i=p,r.catch(fe),r};return h.clearTimeout=()=>{i&&(b.clearTimeout(i),a(),i=r=o=a=void 0,c=!1)},h.isDebounced=()=>!!i,h}function je(t){return["image/jpeg","image/png","image/gif","image/svg+xml","image/webp","image/bmp","video/mp4","video/webm","video/quicktime","audio/ogg","audio/mpeg","audio/mp4","audio/wav","application/json","application/pdf"].indexOf(t)===-1?"application/octet-stream":t}function ge(t,e=""){Array.isArray(t)||(t=[t]);const s=je(e);return new Blob(t,{type:s})}class qe{constructor(e,s,n){this.mimeType=e,this.size=s,this.saveFileCallback=n,this.bytes=new Uint8Array(s)}async write(e,s){const n=s+e.byteLength;if(n>this.bytes.byteLength){const i=new Uint8Array(n);i.set(this.bytes,0),this.bytes=i}this.bytes.set(e,s)}truncate(){this.bytes=new Uint8Array}trim(e){this.bytes=this.bytes.slice(0,e)}finalize(e=!0){const s=ge(this.bytes,this.mimeType);return e&&this.saveFileCallback&&this.saveFileCallback(s),s}getParts(){return this.bytes}replaceParts(e){this.bytes=e}}const q={};function O(t){return q[t]??(q[t]={type:t})}const N=class{constructor(t){this.dbName=t,this.useStorage=!0,T.test&&(this.dbName+="_test"),N.STORAGES.length&&(this.useStorage=N.STORAGES[0].useStorage),this.openDatabase(),N.STORAGES.push(this)}openDatabase(){return this.openDbPromise??(this.openDbPromise=caches.open(this.dbName))}delete(t){return this.timeoutOperation(e=>e.delete("/"+t))}deleteAll(){return caches.delete(this.dbName)}get(t){return this.timeoutOperation(e=>e.match("/"+t))}save(t,e){return this.timeoutOperation(s=>s.put("/"+t,e))}getFile(t,e="blob"){return this.get(t).then(s=>{if(!s)throw O("NO_ENTRY_FOUND");return s[e]()})}saveFile(t,e){e instanceof Blob||(e=ge(e));const s=new Response(e,{headers:{"Content-Length":""+e.size}});return this.save(t,s).then(()=>e)}timeoutOperation(t){return this.useStorage?new Promise(async(e,s)=>{let n=!1;const i=setTimeout(()=>{s(),n=!0},15e3);try{const r=await this.openDatabase();if(!r)throw this.useStorage=!1,this.openDbPromise=void 0,"no cache?";const o=await t(r);if(n)return;e(o)}catch(r){s(r)}clearTimeout(i)}):Promise.reject(O("STORAGE_OFFLINE"))}prepareWriting(t,e,s){return{deferred:F(),getWriter:()=>new qe(s,e,i=>this.saveFile(t,i).catch(()=>i))}}static toggleStorage(t,e){return Promise.all(this.STORAGES.map(s=>{if(s.useStorage=t,!!e&&!t)return s.deleteAll()}))}};let J=N;J.STORAGES=[];function Ge(t){return new Promise(e=>{setTimeout(()=>{e(new Response("",{status:408,statusText:"Request timed out."}))},t)})}const _=new Map,V=new J("cachedStreamChunks"),$e=86400,pe="Time-Cached",ze=()=>V.timeoutOperation(t=>t.keys().then(e=>{const s=new Map,n=Date.now()/1e3|0;for(const r of e){const o=r.url.match(/\/(\d+?)\?/);o&&!s.has(o[1])&&s.set(o[1],r)}const i=[];for(const[r,o]of s){const a=t.match(o).then(c=>{if(+c.headers.get(pe)+$e<=n)return u("will delete stream chunk:",r),t.delete(o,{ignoreSearch:!0,ignoreVary:!0})});i.push(a)}return Promise.all(i)}));setInterval(ze,18e5);setInterval(()=>{const t=Se();for(const[e,s]of _)if(e!==t){for(const n in s)s[n].reject();_.delete(e)}},12e4);const G=new Map;class W{constructor(e){this.info=e,this.loadedOffsets=new Set,this.destroy=()=>{G.delete(this.id)},this.id=W.getId(e),G.set(this.id,this),this.limitPart=e.size>75*1024*1024?Ye:Ke,this.destroyDebounced=Ue(this.destroy,15e4,!1,!0)}async requestFilePartFromWorker(e,s,n=!1){const i={docId:this.id,dcId:this.info.dcId,offset:e,limit:s},r=JSON.stringify(i),o=Se();let a=_.get(o);a||_.set(o,a={});let c=a[r];if(c)return c.then(h=>h.bytes);this.loadedOffsets.add(e),c=a[r]=F(),w.invoke("requestFilePart",i,void 0,o).then(c.resolve.bind(c),c.reject.bind(c)).finally(()=>{a[r]===c&&(delete a[r],Object.keys(a).length||_.delete(o))});const l=c.then(h=>h.bytes);return this.saveChunkToCache(l,e,s),!n&&this.preloadChunks(e,e+this.limitPart*15),l}requestFilePartFromCache(e,s,n){const i=this.getChunkKey(e,s);return V.getFile(i).then(r=>n?new Uint8Array:Be(r),r=>{r.type})}requestFilePart(e,s,n){return this.requestFilePartFromCache(e,s,n).then(r=>r||this.requestFilePartFromWorker(e,s,n))}saveChunkToCache(e,s,n){return e.then(i=>{const r=this.getChunkKey(s,n),o=new Response(i,{headers:{"Content-Length":""+i.length,"Content-Type":"application/octet-stream",[pe]:""+(Date.now()/1e3|0)}});return V.save(r,o)})}preloadChunk(e){this.loadedOffsets.has(e)||(this.loadedOffsets.add(e),this.requestFilePart(e,this.limitPart,!0))}preloadChunks(e,s){if(s>this.info.size&&(s=this.info.size),!e)this.preloadChunk(ne(e,this.limitPart));else for(;e<s;e+=this.limitPart)this.preloadChunk(e)}requestRange(e){this.destroyDebounced();const s=He(e,this.info.mimeType,this.info.size);if(s)return s;let[n,i]=e;const r=i&&i<this.limitPart?Qe(i-n+1):this.limitPart,o=ne(n,r);return i||(i=Math.min(n+r,this.info.size-1)),this.requestFilePart(o,r).then(a=>{(n!==o||i!==o+r)&&(a=a.slice(n-o,i-o+1));const c={"Accept-Ranges":"bytes","Content-Range":`bytes ${n}-${n+a.byteLength-1}/${this.info.size||"*"}`,"Content-Length":`${a.byteLength}`};return this.info.mimeType&&(c["Content-Type"]=this.info.mimeType),new Response(a,{status:206,statusText:"Partial Content",headers:c})})}getChunkKey(e,s){return this.id+"?offset="+e+"&limit="+s}static get(e){return G.get(this.getId(e))??new W(e)}static getId(e){return e.location.id}}function Ve(t,e){const s=Xe(t.request.headers.get("Range")),n=JSON.parse(decodeURIComponent(e)),i=W.get(n);t.respondWith(Promise.race([Ge(45*1e3),i.requestRange(s)]))}function He(t,e,s){return t[0]===0&&t[1]===1?new Response(new Uint8Array(2).buffer,{status:206,statusText:"Partial Content",headers:{"Accept-Ranges":"bytes","Content-Range":`bytes 0-1/${s||"*"}`,"Content-Length":"2","Content-Type":e||"video/mp4"}}):null}const Ke=512*1024,Ye=1024*1024,Je=512*4;function Xe(t){if(!t)return[0,0];const[,e]=t.split("="),s=e.split(", "),[n,i]=s[0].split("-");return[+n,+i||0]}function ne(t,e=Je){return t-t%e}function Qe(t){return 2**Math.ceil(Math.log(t)/Math.log(2))}const Ze={name:"tweb",version:7,stores:[{name:"session"},{name:"stickerSets"},{name:"users"},{name:"chats"},{name:"dialogs"},{name:"messages"}]},et="assets/img/logo_filled_rounded.png",tt="assets/img/logo_plain.svg";function me(t,e,s){const n=s&&new Set(s),i=c=>Object.keys(c).filter(l=>c[l]!==void 0),r=s?c=>i(c).filter(l=>!n.has(l)):i,o=typeof t;return t&&e&&o==="object"&&o===typeof e?r(t).length===r(e).length&&r(t).every(c=>me(t[c],e[c],s)):t===e}function st(t,e){if(e)for(const s in e)e[s]!==void 0&&(t[s]=e[s]);return t}const H=class{constructor(t){st(this,t),T.test&&(this.name+="_test"),this.storageIsAvailable=!0,this.log=R(["IDB",t.name].join("-")),this.log("constructor"),this.openDatabase(!0),H.INSTANCES.push(this)}isAvailable(){return this.storageIsAvailable}openDatabase(t=!1){if(this.openDbPromise&&!t)return this.openDbPromise;const e=(r,o)=>{const a=Array.from(r.indexNames);for(const c of a)r.deleteIndex(c);if(o.indexes?.length)for(const c of o.indexes)r.indexNames.contains(c.indexName)||r.createIndex(c.indexName,c.keyPath,c.objectParameters)},s=(r,o)=>{const a=r.createObjectStore(o.name);e(a,o)};try{var n=indexedDB.open(this.name,this.version);if(!n)return Promise.reject()}catch(r){return this.log.error("error opening db",r.message),this.storageIsAvailable=!1,Promise.reject(r)}let i=!1;return setTimeout(()=>{i||n.onerror(O("IDB_CREATE_TIMEOUT"))},3e3),this.openDbPromise=new Promise((r,o)=>{n.onsuccess=a=>{i=!0;const c=n.result;let l=!1;this.log("Opened"),c.onerror=h=>{this.storageIsAvailable=!1,this.log.error("Error creating/accessing IndexedDB database",h),o(h)},c.onclose=h=>{this.log.error("closed:",h),!l&&this.openDatabase()},c.onabort=h=>{this.log.error("abort:",h);const d=h.target;this.openDatabase(l=!0),d.onerror&&d.onerror(h),c.close()},c.onversionchange=h=>{this.log.error("onversionchange, lol?")},r(this.db=c)},n.onerror=a=>{i=!0,this.storageIsAvailable=!1,this.log.error("Error creating/accessing IndexedDB database",a),o(a)},n.onupgradeneeded=a=>{i=!0,this.log.warn("performing idb upgrade from",a.oldVersion,"to",a.newVersion);const c=a.target,l=c.result;this.stores.forEach(h=>{if(!l.objectStoreNames.contains(h.name))s(l,h);else{const p=c.transaction.objectStore(h.name);e(p,h)}})}})}static create(t){return this.INSTANCES.find(e=>e.name===t.name)??new H(t)}static closeDatabases(t){this.INSTANCES.forEach(e=>{if(t&&t===e)return;const s=e.db;s&&(s.onclose=()=>{},s.close())})}};let we=H;we.INSTANCES=[];class nt{constructor(e,s){this.storeName=s,this.log=R(["IDB",e.name,s].join("-")),this.idb=we.create(e)}delete(e,s){const n=Array.isArray(e);return n||(e=[].concat(e)),this.getObjectStore("readwrite",i=>{const r=e.map(o=>i.delete(o));return n?r:r[0]},"",s)}clear(e){return this.getObjectStore("readwrite",s=>s.clear(),"",e)}save(e,s,n){const i=Array.isArray(e);return i||(e=[].concat(e),s=[].concat(s)),this.getObjectStore("readwrite",r=>{const o=e.map((a,c)=>r.put(s[c],a));return i?o:o[0]},"",n)}get(e,s){const n=Array.isArray(e);if(n){if(!e.length)return Promise.resolve([])}else{if(!e)return;e=[].concat(e)}return this.getObjectStore("readonly",i=>{const r=e.map(o=>i.get(o));return n?r:r[0]},"",s)}getObjectStore(e,s,n,i=this.storeName){let r;return n&&(r=performance.now(),this.log(n+": start")),this.idb.openDatabase().then(o=>new Promise((a,c)=>{const l=o.transaction([i],e),h=()=>{clearTimeout(g),c(l.error)},d=()=>{clearTimeout(g),n&&this.log(n+": end",performance.now()-r);const E=U.map(D=>D.result);a(X?E:E[0])};l.onerror=h;const p=e==="readwrite";p&&(l.oncomplete=()=>d());const g=setTimeout(()=>{this.log.error("transaction not finished",l,n)},1e4),f=s(l.objectStore(i)),X=Array.isArray(f),U=X?f:[].concat(f);if(p)return;const Q=U.length;let ye=Q;const Ae=()=>{l.error||--ye||d()};for(let E=0;E<Q;++E){const D=U[E];D.onerror=h,D.onsuccess=Ae}}))}getAll(e){return this.getObjectStore("readonly",s=>s.getAll(),"",e)}}const k=self,it=location.protocol+"//"+location.hostname+location.pathname.split("/").slice(0,-1).join("/")+"/",rt=1e4+1500;let ke=0,ve=!0;class ot{constructor(e,s,n){this.defaults=n,this.cache={},this.storage=new nt(e,s)}getDefault(e){const s=this.defaults[e];return typeof s=="function"?s():s}get(e){return this.cache.hasOwnProperty(e)?this.cache[e]:this.storage.get(e).then(n=>n,()=>{}).then(n=>this.cache.hasOwnProperty(e)?this.cache[e]:(n??(n=this.getDefault(e)),this.cache[e]=n))}getCached(e){const s=this.get(e);if(s instanceof Promise)throw"no property";return s}async set(e,s){const n=this.cache[e]??this.defaults[e];if(!me(n,s)){this.cache[e]=s;try{this.storage.save(e,s)}catch{}}}}const Pe={push_mute_until:0,push_lang:{push_message_nopreview:"You have a new message",push_action_mute1d:"Mute for 24H",push_action_settings:"Settings"},push_settings:{}},S=new ot(Ze,"session",Pe);for(const t in Pe)S.get(t);k.addEventListener("push",t=>{const e=t.data.json();u("push",{...e});try{const[s,n,i]=[S.getCached("push_mute_until"),S.getCached("push_settings"),S.getCached("push_lang")],r=Date.now();if(be()&&s&&r<s)throw`supress notification because mute for ${Math.ceil((s-r)/6e4)} min`;if(Date.now()-ke<=rt&&ve)throw"supress notification because some instance is alive";const a=ht(e,n,i);t.waitUntil(a)}catch(s){u(s)}});k.addEventListener("notificationclick",t=>{const e=t.notification;u("on notification click",e),e.close();const s=t.action;if(s==="mute1d"&&be()){u("[SW] mute for 1d"),S.set("push_mute_until",Date.now()+864e5);return}const n=e.data;if(!n)return;const i=k.clients.matchAll({type:"window"}).then(r=>{n.action=s,y=n;for(let o=0;o<r.length;++o){const a=r[o];if("focus"in a){a.focus(),w.invokeVoid("pushClick",y,a),y=void 0;return}}if(k.clients.openWindow)return Promise.resolve(S.get("push_settings")).then(o=>k.clients.openWindow(o.baseUrl||it))}).catch(r=>{u.error("Clients.matchAll error",r)});t.waitUntil(i)});k.addEventListener("notificationclose",at);const K=new Set;let y;function at(t){ct(t.notification)}function ct(t){K.delete(t)}function lt(t){for(const s of K)try{if(t&&s.tag!==t)continue;s.close(),K.delete(s)}catch{}let e;return"getNotifications"in k.registration?e=k.registration.getNotifications({tag:t}).then(s=>{for(let n=0,i=s.length;n<i;++n)try{s[n].close()}catch{}}).catch(s=>{u.error("Offline register SW error",s)}):e=Promise.resolve(),e}function be(){return re}function ht(t,e,s){let n=t.title||"Telegram",i=t.description||"",r;t.custom&&(t.custom.channel_id?r=""+-t.custom.channel_id:t.custom.chat_id?r=""+-t.custom.chat_id:r=t.custom.from_id||""),t.custom.peerId=""+r;let o="peer"+r;const a=r+"_"+t.custom.msg_id;if(M.has(a)){const d="ignoring push";throw u.warn(d,t),M.delete(a),d}e?.nopreview&&(n="Telegram",i=s.push_message_nopreview,o="unknown_peer");const c=[{action:"mute1d",title:s.push_action_mute1d}],l={body:i,icon:et,tag:o,data:t,actions:c,badge:tt,silent:t.custom.silent==="1"};return u("show notify",n,i,t,l),k.registration.showNotification(n,l).catch(d=>{u.error("Show notification promise",d)})}function ut(t,e){ke=Date.now(),ve=t.localNotifications,y&&e&&(w.invokeVoid("pushClick",y,e),y=void 0),t.lang&&S.set("push_lang",t.lang),t.settings&&S.set("push_settings",t.settings)}const M=new Map;function dt(t){M.set(t,Date.now())}setInterval(()=>{const t=Date.now();M.forEach((e,s)=>{t-e>3e4&&M.delete(s)})},30*6e4);const ft=Date.now()%Math.random()*1e8|0;function $(t,e){const s=t.indexOf(e);return(s===-1?void 0:t.splice(s,1))?.[0]}function gt(t,e){const s=t.findIndex(e);return s!==-1?t.splice(s,1)[0]:void 0}class pt{constructor(e){this._constructor(e)}_constructor(e){this.reuseResults=e,this.listeners={},this.listenerResults={}}addEventListener(e,s,n){var i;if(((i=this.listeners)[e]??(i[e]=[])).push({callback:s,options:n}),this.listenerResults.hasOwnProperty(e)&&(s(...this.listenerResults[e]),n?.once)){this.listeners[e].pop();return}}addMultipleEventsListeners(e){for(const s in e)this.addEventListener(s,e[s])}removeEventListener(e,s,n){this.listeners[e]&&gt(this.listeners[e],i=>i.callback===s)}invokeListenerCallback(e,s,...n){let i,r;try{i=s.callback(...n)}catch(o){r=o}if(s.options?.once&&this.removeEventListener(e,s.callback),r)throw r;return i}_dispatchEvent(e,s,...n){this.reuseResults&&(this.listenerResults[e]=n);const i=s&&[],r=this.listeners[e];return r&&r.slice().forEach(a=>{if(r.findIndex(h=>h.callback===a.callback)===-1)return;const l=this.invokeListenerCallback(e,a,...n);i&&i.push(l)}),i}dispatchResultableEvent(e,...s){return this._dispatchEvent(e,!0,...s)}dispatchEvent(e,...s){this._dispatchEvent(e,!1,...s)}cleanup(){this.listeners={},this.listenerResults={}}}const mt=!0;class wt extends pt{constructor(e){super(!1),this.logSuffix=e,this.onMessage=s=>{const n=s.data,i=s.source||s.currentTarget;this.processTaskMap[n.type](n,i,s)},this.processResultTask=s=>{const{taskId:n,result:i,error:r}=s.payload,o=this.awaiting[n];o&&(this.debug&&this.log.debug("done",o.taskType,i,r),"error"in s.payload?o.reject(r):o.resolve(i),delete this.awaiting[n])},this.processAckTask=s=>{const n=s.payload,i=this.awaiting[n.taskId];if(!i)return;const r=i.resolve,o={cached:n.cached,result:n.cached?"result"in n?Promise.resolve(n.result):Promise.reject(n.error):new Promise((a,c)=>{i.resolve=a,i.reject=c})};r(o),n.cached&&delete this.awaiting[n.taskId]},this.processPingTask=(s,n,i)=>{this.pushTask(this.createTask("pong",void 0),i.source)},this.processPongTask=(s,n,i)=>{const r=this.pingResolves.get(n);r&&(this.pingResolves.delete(n),r())},this.processCloseTask=(s,n,i)=>{this.detachPort(n)},this.processBatchTask=(s,n,i)=>{const r={data:i.data,source:i.source,currentTarget:i.currentTarget};s.payload.forEach(o=>{r.data=o,this.onMessage(r)})},this.processLockTask=(s,n,i)=>{const r=s.payload;this.requestedLocks.has(r)||(this.requestedLocks.set(r,n),navigator.locks.request(r,()=>{this.processCloseTask(void 0,n,void 0),this.requestedLocks.delete(r)}))},this.processInvokeTask=async(s,n,i)=>{const r=s.id,o=s.payload;let a,c,l;o.void||(a={taskId:r},c=this.createTask("result",a)),o.withAck&&(l=this.createTask("ack",{taskId:r,cached:!0}));let h;try{const d=this.listeners[o.type];if(!d?.length)throw new Error("no listener");const p=d[0];let g=this.invokeListenerCallback(o.type,p,o.payload,n,i);if(o.void)return;if(h=g instanceof Promise,l){const f=!h;if(l.payload.cached=f,f&&(l.payload.result=g),this.pushTask(l,n),f)return}h&&(g=await g),a.result=g}catch(d){if(this.log.error("worker task error:",d,s),o.void)return;if(l&&l.payload.cached){l.payload.error=d,this.pushTask(l,n);return}a.error=d}this.pushTask(c,n)},this.listenPorts=[],this.sendPorts=[],this.pingResolves=new Map,this.taskId=0,this.awaiting={},this.pending=new Map,this.log=R("MP"+(e?"-"+e:"")),this.debug=Y,this.heldLocks=new Map,this.requestedLocks=new Map,this.processTaskMap={result:this.processResultTask,ack:this.processAckTask,invoke:this.processInvokeTask,ping:this.processPingTask,pong:this.processPongTask,close:this.processCloseTask,lock:this.processLockTask,batch:this.processBatchTask}}setOnPortDisconnect(e){this.onPortDisconnect=e}attachPort(e){this.attachListenPort(e),this.attachSendPort(e)}attachListenPort(e){this.listenPorts.push(e),e.addEventListener("message",this.onMessage)}attachSendPort(e){if(this.log.warn("attaching send port"),e.start?.(),this.sendPorts.push(e),typeof window<"u"&&mt)if("locks"in navigator){const s=["lock",ft,this.logSuffix||"",Math.random()*2147483647|0].join("-");this.log.warn("created lock",s);const n=new Promise(i=>this.heldLocks.set(e,{resolve:i,id:s})).then(()=>this.heldLocks.delete(e));navigator.locks.request(s,()=>(this.resendLockTask(e),n))}else window.addEventListener("beforeunload",()=>{const s=this.createTask("close",void 0);this.postMessage(void 0,s)});this.releasePending()}resendLockTask(e){const s=this.heldLocks.get(e);s&&this.pushTask(this.createTask("lock",s.id),e)}detachPort(e){this.log.warn("disconnecting port"),$(this.listenPorts,e),$(this.sendPorts,e),e.removeEventListener?.("message",this.onMessage),e.close?.(),this.onPortDisconnect?.(e),this.heldLocks.get(e)?.resolve();const n=O("PORT_DISCONNECTED");for(const i in this.awaiting){const r=this.awaiting[i];r.port===e&&(r.reject(n),delete this.awaiting[i])}}postMessage(e,s){(Array.isArray(e)?e:e?[e]:this.sendPorts).forEach(i=>{i.postMessage(s,s.transfer)})}async releasePending(){this.releasingPending||(this.releasingPending=!0,await Promise.resolve(),this.debug&&this.log.debug("releasing tasks, length:",this.pending.size),this.pending.forEach((e,s)=>{let n=e;{let r;n=[],e.forEach(o=>{o.transfer?(r=void 0,n.push(o)):(r||(r=this.createTask("batch",[]),n.push(r)),r.payload.push(o))})}const i=s?[s]:this.sendPorts;i.length&&(n.forEach(r=>{try{this.postMessage(i,r)}catch(o){this.log.error("postMessage error:",o,r,i)}}),this.pending.delete(s))}),this.debug&&this.log.debug("released tasks"),this.releasingPending=!1)}createTask(e,s,n){return{type:e,payload:s,id:this.taskId++,transfer:n}}createInvokeTask(e,s,n,i,r){return this.createTask("invoke",{type:e,payload:s,withAck:n,void:i},r)}pushTask(e,s){let n=this.pending.get(s);n||this.pending.set(s,n=[]),n.push(e),this.releasePending()}invokeVoid(e,s,n,i){const r=this.createInvokeTask(e,s,void 0,!0,i);this.pushTask(r,n)}invoke(e,s,n,i,r){this.debug&&this.log.debug("start",e,s);let o;const a=new Promise((c,l)=>{o=this.createInvokeTask(e,s,n,void 0,r),this.awaiting[o.id]={resolve:c,reject:l,taskType:e,port:i},this.pushTask(o,i)});if(_e){a.finally(()=>{clearInterval(c)});const c=b.setInterval(()=>{this.log.error("task still has no result",o,i)},6e4)}return a}invokeExceptSource(e,s,n){const i=this.sendPorts.slice();$(i,n),i.forEach(r=>{this.invokeVoid(e,s,r)})}}class kt extends wt{constructor(){super("SERVICE"),Z&&(Z.serviceMessagePort=this)}}function vt(t,e,s){const n=(i,r)=>{t.attachListenPort(i),r&&t.attachSendPort(r),e?.(i)};t.setOnPortDisconnect(s),typeof SharedWorkerGlobalScope<"u"?b.addEventListener("connect",i=>n(i.source,i.source)):typeof ServiceWorkerGlobalScope<"u"?n(b,null):n(b,b)}const m=new Map,z=O("UNKNOWN"),Pt=!1;self.downloadMap=m;const bt={download:t=>{const{id:e}=t;if(m.has(e))return Promise.reject(z);const s=new CountQueuingStrategy({highWaterMark:1}),n=F();n.then(()=>{setTimeout(()=>{m.delete(e)},5e3)},()=>{m.delete(e)});let i;const r=new ReadableStream({start:a=>{i=a},cancel:a=>{n.reject(z)}},s),o={...t,readableStream:r,promise:n,controller:i};return m.set(e,o),n.catch(()=>{throw z})},downloadChunk:({id:t,chunk:e})=>{const s=m.get(t);return s?s.controller.enqueue(e):Promise.reject()},downloadFinalize:t=>{const e=m.get(t);return e?(e.promise.resolve(),e.controller.close()):Promise.reject()},downloadCancel:t=>{const e=m.get(t);if(e)return e.promise.reject(),e.controller.error()}};function St(t){return t.addMultipleEventsListeners(bt),{onDownloadFetch:Tt,onClosedWindows:Et}}function Tt(t,e){const s=ue(100).then(()=>{const n=m.get(e);if(!n||n.used&&!Pt)return;n.used=!0;const i=n.readableStream;return new Response(i,{headers:n.headers})});t.respondWith(s)}function Et(){if(m.size)for(const[t,e]of m)e.controller.error()}const I={};function yt(t){return{files:t.getAll("files"),title:t.get("title"),text:t.get("text"),url:t.get("url")}}async function At(t,e){try{u("share data",t);const s=yt(t);(I[e]??(I[e]=[])).push(s)}catch(s){u.warn("something wrong with the data",s)}}function Ct(t){const e=I[t.id];e&&(delete I[t.id],u("releasing share events to client:",t.id,"length:",e.length),e.forEach(s=>{w.invokeVoid("share",s,t)}))}function _t(t,e){const s=t.request.formData().then(n=>(At(n,t.resultingClientId),Response.redirect("..")));t.respondWith(s)}const u=R("SW",C.Error|C.Debug|C.Log|C.Warn,!0),v=self;let A;const Se=()=>A;u("init");const It=t=>{const e=new MessageChannel;w.attachPort(A=e.port1),w.invokeVoid("port",void 0,t,[e.port2])},Ot=t=>{!P.size&&!A&&(u("sending message port for mtproto"),It(t))},Te=t=>{if(u("window connected",t.id,"windows before",P.size),t.frameType==="none"){u.warn("maybe a bugged Safari starting window",t.id);return}u("windows",Array.from(P)),w.invokeVoid("hello",void 0,t),Ot(t),P.set(t.id,t),Ct(t)},w=new kt;w.addMultipleEventsListeners({notificationsClear:lt,toggleStorages:({enabled:t,clearWrite:e})=>{J.toggleStorage(t,e)},pushPing:(t,e)=>{ut(t,e)},hello:(t,e)=>{Te(e)},shownNotification:dt});const{onDownloadFetch:Mt,onClosedWindows:xt}=St(w);oe().then(t=>{u(`got ${t.length} windows from the start`),t.forEach(e=>{Te(e)})});const P=new Map;self.connectedWindows=P;vt(w,void 0,t=>{if(u("something has disconnected",t),!(t instanceof WindowClient)||!P.has(t.id)){u.warn("it is not a window");return}P.delete(t.id),u("window disconnected, left",P.size),P.size||(u.warn("no windows left"),A&&(w.detachPort(A),A=void 0),xt())});const Rt=t=>{if(!ie&&t.request.url.indexOf(location.origin+"/")===0&&t.request.url.match(/\.(js|css|jpe?g|json|wasm|png|mp3|svg|tgs|ico|woff2?|ttf|webmanifest?)(?:\?.*)?$/))return t.respondWith(Le(t));try{const[e,s]=t.request.url.split("/").slice(-2);switch(e){case"stream":{Ve(t,s);break}case"download":{Mt(t,s);break}case"share":{_t(t,s);break}case"ping":{t.respondWith(new Response("pong"));break}}}catch(e){u.error("fetch error",e),t.respondWith(new Response("",{status:500,statusText:"Internal Server Error",headers:{"Cache-Control":"no-cache"}}))}},Ee=()=>{v.onfetch=Rt};v.addEventListener("install",t=>{u("installing"),t.waitUntil(v.skipWaiting().then(()=>u("skipped waiting")))});v.addEventListener("activate",t=>{u("activating",v),t.waitUntil(v.caches.delete(de).then(()=>u("cleared assets cache"))),t.waitUntil(v.clients.claim().then(()=>u("claimed clients")))});v.onoffline=v.ononline=Ee;Ee();
//# sourceMappingURL=sw-d32a1409.js.map
